
---
title: "Phylogenetic Analysis of Salamander Genome Size"
author: "Clay Cressler"
date: "06/09/2020"
output: bookdown::html_document2
self_contained: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      dev=c('png','tiff'),
                      fig.path='figures/')
library(OUwie)
library(tidyverse)
library(parallel)

```

This markdown script contains all of the code necessary to replicate the phylogenetic comparative analyses of salamander genome size found in the manuscript, "Mueller et al. Metamorphosis imposes variable constraints on genome expansion."

```{r, echo=FALSE}
## Load in the consensus phylogenetic tree 
tree <- read.tree("JP_MLtree_118spp_meanbrlens.tre")
## Load in the regime information for internal nodes
nodedata <- readRDS("nodedata_ancPlethM.RDS")
## Load in the genome size and life history data and modify it for OUwie analyses
tab <- read.csv("Data_Supp_Table_9-1-21.csv")
mutate(tab,
       labels=paste(Genus,Species,sep="_"),
       meta.other=unname(sapply(as.character(LifeHistoryStrategy),
                                function(lh)
                                  switch(lh,"D"="other","M"="metamorphosis","Mpleth"="metamorphosis","P"="other"))),
       meta.dd.paed=unname(sapply(as.character(LifeHistoryStrategy),
                                  function(lh) switch(lh,"D"="direct development","M"="metamorphosis","Mpleth"="metamorphosis","P"="paedomorphosis"))),
       metap.np.other=unname(sapply(as.character(LifeHistoryStrategy),
                                function(lh) switch(lh,"D"="other","M"="meta-np","Mpleth"="meta-p","P"="other"))),
       metap.np.dd.paed=unname(sapply(as.character(LifeHistoryStrategy),
                                function(lh) switch(lh,"D"="direct development","M"="meta-np","Mpleth"="meta-p","P"="paedomorphosis"))),
       genomesize=log(GenomeSize))[,5:10] -> tipdata
## Put the data in tip.label order
tipdata <- tipdata[match(tree$tip.label,tipdata$labels),]

tree_meta.other <- tree_meta.dd.paed <- tree_metap.np.other <- tree_metap.np.dd.paed <- tree
tree_meta.other$node.label <- nodedata$meta.other
tree_meta.dd.paed$node.label <- nodedata$meta.dd.paed
tree_metap.np.other$node.label <- nodedata$metap.np.other
tree_metap.np.dd.paed$node.label <- nodedata$metap.np.dd.paed

```
Here are the four different adaptive hypothesis regime paintings (Fig. \@ref(fig:hyp)). 

```{r hyp, echo=FALSE, fig.height=10, fig.width=10, fig.cap="The four evolutionary hypotheses, specified as regime paintings. Black = Direct development, Red = Metamorphosis, Green = Plethodontid metamorphosis, Blue = Paedomorphosis, Cyan = Direct development or paedomorphosis."}

par(mar=c(1,0.5,1,0.5), oma=c(0.5,0.5,0.5,0.5), mfrow=c(1, 6))
plot(tree_meta.other, show.tip.label=FALSE)
mtext("meta", side=3, line=-1, cex=0.75)
nodelabels(pch=21, bg=as.numeric(as.factor(tree_meta.other$node.label)))

plot(tree_meta.nf, show.tip.label=FALSE)
mtext("meta-nf", side=3, line=-1, cex=0.75)
nodelabels(pch=21, bg=tree_meta.nf$node.label)

plot(tree_meta.dd.paed, show.tip.label=FALSE)
mtext("meta-paed-dd", side=3, line=-1, cex=0.75)
nodelabels(pch=21, bg=tree_meta.dd.paed$node.label)

par(mar=c(1,0.5,1,0))
plot(tree_meta.nf.dd.paed, show.tip.label=FALSE)
mtext("meta-nf-paed-dd", side=3, line=-1, cex=0.75)
nodelabels(pch=21, bg=tree_meta.nf.dd.paed$node.label)

par(mar=c(1,0,1,0))
plot.new()
plot.window(xlim=c(0,max(exp(data.meta$genomesize))), ylim=c(0,1))
axis(1, line=-2)
for (i in 1:length(tree_meta$tip.label))
  lines(c(0, exp(data.meta[data.meta$labels==tree_meta$tip.label[i],'genomesize'])),
        rep(1-(i-1)/(length(tree_meta$tip.label)-1),2),
        col=2, lwd=3)
mtext("Genome size (pg)", side=3, line=-1, cex=0.75)

par(mar=c(1,0,1,0))
plot.new()
plot.window(xlim=c(0,1), ylim=c(0,1))
for (i in 1:length(tree_meta$tip.label))
    text(0, 1-(i-1)/(length(tree_meta$tip.label)-1),
         paste(strsplit(tree_meta$tip.label[i],"_")[[1]][1], strsplit(tree_meta$tip.label[i],"_")[[1]][2]),
         cex=0.65, adj=0)

```
I will proceed with fitting the following models: a standard Brownian motion model (BM1), a Brownian motion model where the drift parameter ($\sigma$) varies across regimes (BMS), an Ornstein-Uhlenbeck (OU) model where only $\theta$ varies across regimes (OUM), an OU model where selection strength varies across regimes ($\alpha$) (OUMA), an OU model where drift varies across regimes (OUMV), and an OU model where both selection and drift vary across regimes (OUMVA). 

```{r, echo=FALSE, eval=FALSE}
set.seed(1234321)

bm.ouwie <- OUwie(tree_meta.other,data=tipdata[,c("labels","meta.other","genomesize")],model=c("BM1"),root.station=FALSE,scaleHeight=TRUE,quiet=TRUE)
## Fit all of the model variants (BMS, OUMA, OUMV, OUMVA) to each hypothesis
meta.other.OUM <- OUwie(tree_meta.other,data=tipdata[,c("labels","meta.other","genomesize")],model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.other.BMS <- OUwie(tree_meta.other,data=tipdata[,c("labels","meta.other","genomesize")],model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.other.OUMA <- OUwie(tree_meta.other,data=tipdata[,c("labels","meta.other","genomesize")],model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.other.OUMV <- OUwie(tree_meta.other,data=tipdata[,c("labels","meta.other","genomesize")],model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.other.OUMVA <- OUwie(tree_meta.other,data=tipdata[,c("labels","meta.other","genomesize")],model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

meta.dd.paed.OUM <- OUwie(tree_meta.dd.paed,data=tipdata[,c("labels","meta.dd.paed","genomesize")],model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.BMS <- OUwie(tree_meta.dd.paed,data=tipdata[,c("labels","meta.dd.paed","genomesize")],model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.OUMA <- OUwie(tree_meta.dd.paed,data=tipdata[,c("labels","meta.dd.paed","genomesize")],model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.OUMV <- OUwie(tree_meta.dd.paed,data=tipdata[,c("labels","meta.dd.paed","genomesize")],model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.OUMVA <- OUwie(tree_meta.dd.paed,data=tipdata[,c("labels","meta.dd.paed","genomesize")],model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

metap.np.other.OUM <- OUwie(tree_metap.np.other,data=tipdata[,c("labels","metap.np.other","genomesize")],model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.other.BMS <- OUwie(tree_metap.np.other,data=tipdata[,c("labels","metap.np.other","genomesize")],model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.other.OUMA <- OUwie(tree_metap.np.other,data=tipdata[,c("labels","metap.np.other","genomesize")],model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.other.OUMV <- OUwie(tree_metap.np.other,data=tipdata[,c("labels","metap.np.other","genomesize")],model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.other.OUMVA <- OUwie(tree_metap.np.other,data=tipdata[,c("labels","metap.np.other","genomesize")],model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

metap.np.dd.paed.OUM <- OUwie(tree_metap.np.dd.paed,data=tipdata[,c("labels","metap.np.dd.paed","genomesize")],model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.dd.paed.BMS <- OUwie(tree_metap.np.dd.paed,data=tipdata[,c("labels","metap.np.dd.paed","genomesize")],model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.dd.paed.OUMA <- OUwie(tree_metap.np.dd.paed,data=tipdata[,c("labels","metap.np.dd.paed","genomesize")],model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.dd.paed.OUMV <- OUwie(tree_metap.np.dd.paed,data=tipdata[,c("labels","metap.np.dd.paed","genomesize")],model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metap.np.dd.paed.OUMVA <- OUwie(tree_metap.np.dd.paed,data=tipdata[,c("labels","metap.np.dd.paed","genomesize")],model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

## save these results
results <- list(BM1=bm.ouwie,
                meta.other.OUM=meta.other.OUM,
                meta.other.BMS=meta.other.BMS,
                meta.other.OUMA=meta.other.OUMA,
                meta.other.OUMV=meta.other.OUMV,
                meta.other.OUMVA=meta.other.OUMVA,
                metap.np.other.OUM=metap.np.other.OUM,
                metap.np.other.BMS=metap.np.other.BMS,
                metap.np.other.OUMA=metap.np.other.OUMA,
                metap.np.other.OUMV=metap.np.other.OUMV,
                metap.np.other.OUMVA=metap.np.other.OUMVA,
                meta.dd.paed.OUM=meta.dd.paed.OUM,
                meta.dd.paed.BMS=meta.dd.paed.BMS,
                meta.dd.paed.OUMA=meta.dd.paed.OUMA,
                meta.dd.paed.OUMV=meta.dd.paed.OUMV,
                meta.dd.paed.OUMVA=meta.dd.paed.OUMVA,
                metap.np.dd.paed.OUM=metap.np.dd.paed.OUM,
                metap.np.dd.paed.BMS=metap.np.dd.paed.BMS,
                metap.np.dd.paed.OUMA=metap.np.dd.paed.OUMA,
                metap.np.dd.paed.OUMV=metap.np.dd.paed.OUMV,
                metap.np.dd.paed.OUMVA=metap.np.dd.paed.OUMVA
                )
saveRDS(results, "all_model_fits_new.RDS")

```

```{r, echo=FALSE}
results <- readRDS("all_model_fits_new.RDS")
```

It is clear from the table below summarizing the model fits that the multiple-$\alpha$ models (OUMA and OUMVA) produce fitting errors. 
This can be seen in the log-likelihoods, which if believed are often several orders of magnitude better than simpler models, and from the parameer estimates, which often include at least one parameter that is estimated to be approximately 0.
The only model where this was not the case was OUMA for the simplest adaptive hypothesis (meta.other), which is perhaps unsurprising because that was one of the only models where OUwie did not warn about not having enough data to fit the model.
Because almost all of the multiple-$\alpha$ models produced fitting errors, we have decided to discard all of them and focus only Brownian motion models (BM1 and BMS); single-$\alpha$, single-$\sigma$ models (OUM); and single-$\alpha$, multiple-$\sigma$ models (OUMV).

```{r, echo=FALSE}
data.frame(Hypothesis = lapply(results, function(x) x$AICc) %>% unlist %>% names,
           loglik = lapply(results, function(x) x$loglik) %>% unlist %>% signif(3),
           AICc = lapply(results, function(x) x$AICc) %>% unlist %>% signif(3),
           alpha = lapply(results, function(x) unique(x$solution['alpha',]) %>% signif(3) %>% paste(., collapse=", ")) %>% unlist,
           sigma = lapply(results, function(x) unique(x$solution['sigma.sq',]) %>% sqrt %>% signif(3) %>% paste(., collapse=", ")) %>% unlist,
           theta = lapply(results, function(x) x$theta[,1] %>% signif(3) %>% paste(., collapse=", ")) %>% unlist
           ) %>% 
    arrange(AICc) -> aics
rownames(aics) <- as.character(1:nrow(aics))
aics[sort(c(grep("OUMA",aics$Hypothesis), grep("OUMVA",aics$Hypothesis))),]
                      
```
Of these, the best-fitting model is the OU model with 4 selective regimes, with separate drift parameters for each regime.
Here are the AICc values and parameter estimates for each of the models.
```{r,echo=FALSE}
aics[-sort(c(grep("OUMA",aics$Hypothesis), grep("OUMVA",aics$Hypothesis))),]
```

One way to help visualize what this best-fitting model is telling us is by looking at the distribution of genome sizes for species in each selective regime, relative to the expected stationary distribution of genome sizes, given the model estimates for $\theta$, $\alpha$, and $\sigma$. 
In particular, Ho and Ane (2013) showed that the stationary distribution of an OU process will be a normal distribution with mean $\theta$ and variance $\sigma^2/(2\alpha)$.
```{r, echo=FALSE, fig.height=4, fig.width=6.5, fig.cap="Observed distributions of genome size in each selective regime compared against the stationary distribution predicted by the OUMV model (dashed line)."}
par(mfrow=c(1,4), oma=c(2,2,0,0), mar=c(1.5,1.5,2,0.5))
for (i in 1:4) {
  hyp <- c("direct development", "meta-np", "meta-p", "paedomorphosis")[i]
  sigma <- sqrt(results[["metap.np.dd.paed.OUMV"]]$solution['sigma.sq',hyp]/(2*results[["metap.np.dd.paed.OUMV"]]$solution['alpha',hyp]))
  mu <- results[["metap.np.dd.paed.OUMV"]]$theta[i,1]
  y <- hist(tipdata$genomesize[tipdata$metap.np.dd.paed==hyp], plot=FALSE)
  xhigh <- max(c(qnorm(0.995,mean=mu,sd=sigma), max(y$breaks)))
  xlow <- min(c(qnorm(0.005,mean=mu,sd=sigma), min(y$breaks)))
  xseq <- seq(floor(xlow),ceiling(xhigh),0.01)
  title <- switch(hyp, "direct development"="Direct\nDevelopment", "meta-np"="Meta-\nNon-Pleth", "meta-p"="Meta-\nPleth", "paedomorphosis"="Paedo-\nmorphosis")
  hist(tipdata$genomesize[tipdata$metap.np.dd.paed==hyp], freq=FALSE, main=title, xlab="", ylab="", xlim=range(xseq), ylim=c(0,max(max(y$density),dnorm(mu,mean=mu,sd=sigma))))
  lines(xseq, 1/(sigma*sqrt(2*pi))*exp(-(xseq-mu)^2/(2*sigma^2)), lwd=2, lty=2)
}


```



However, it is important to assess how strong the support for this hypothesis truly is. 
Following the protocol of Boettiger et al. (2012) for phylogenetic Monte Carlo, I need to simulate datasets under different models and ask how often the true (data-generating) model is rejected in favor of an alternative model.

We will do the following pairwise comparisons of models: 

1. $metamorphosis-other$ (OUMV) versus $BM$. 

2. $meta-paed-dd$ (OUMV) versus $metamorphosis-other$ (OUMV). 

3. $meta_p-meta_{np}-other$ (OUMV) versus $metamorphosis-other$ (OUMV).

4. $meta_p-meta_{np}-paed-dd$ (OUMV) versus $meta-paed-dd$ (OUMV). 

5. $meta_p-meta_{np}-paed-dd$ (OUMV) versus $meta_p-meta_{np}-other$ (OUMV). 

6. $meta_p_meta_{np}-paed-dd$ (OUMV) versus $meta_p_meta_{np}-paed-dd$ (OUM)

Comparison (1) tests whether we can confidently reject a non-adaptive hypothesis for genome size evolution.
Comparisons (2) and (5) test whether distinguishing direct development and paedomorphosis is supported.
Comparisons (3) and (4) test whether distinguishing plethodontid and non-plethodontid metamorphosis is supported.
Comparison (6) tests whether allowing separate drift parameters for each regime is supported.
We will simulate datasets under all of the models above, and then fit data generated by each of the two models under comparison to each of those models.


```{r, eval=FALSE, echo=FALSE}

## Generate 500 simulated datasets under each of the 5 models of interest
PMCdata <- list(length=500)
set.seed(1098743)
for (i in 1:500) {
  print(i)
  ## simulate a dataset with each of the 5 models under consideration
  ## Brownian motion
  OUwie.sim(tree_meta.other, 
            tipdata[,c("labels","meta.other","genomesize")], 
            shift.point=1, 
            scaleHeight = TRUE,
            alpha = c(1e-10,1e-10),
            sigma.sq = rep(results[["BM1"]]$solution["sigma.sq",],2),
            theta0 = results[["BM1"]]$theta[1,1],
            theta = c(0,0)
            ) -> bm1.data
  bm1.data[,2] <- tipdata[,"meta.other"]
  for (hyp in c("meta.other","meta.dd.paed","metap.np.other","metap.np.dd.paed")) {
    tree <- get(paste("tree",hyp,sep="_"))
    data <- tipdata[,c("labels",hyp,"genomesize")]
    OUwie.sim(tree, 
              data, 
              shift.point=1, 
              scaleHeight=TRUE,
              fitted.object=results[[paste(hyp,"OUMV",sep=".")]]) -> sim
    sim[,2] <- data[,2] ## OUwie.sim rewrites the names of the regimes, so fix that now
    assign(paste("oumv",hyp,"data",sep='.'),sim)
    
    if (hyp=="metap.np.dd.paed") {## also fit the OUM version of the model
      OUwie.sim(tree, 
                data, 
                shift.point=1, 
                scaleHeight=TRUE,
                fitted.object=results[[paste(hyp,"OUM",sep=".")]]) -> sim
      sim[,2] <- data[,2]
      assign(paste("oum",hyp,"data",sep='.'),sim)  
    }
  }
  PMCdata[[i]] <- list(bm1.data=bm1.data,
                       oumv.meta.other.data=oumv.meta.other.data,
                       oumv.metap.np.other.data=oumv.metap.np.other.data,
                       oumv.meta.dd.paed.data=oumv.meta.dd.paed.data,
                       oum.metap.np.dd.paed.data=oum.metap.np.dd.paed.data,
                       oumv.metap.np.dd.paed.data=oumv.metap.np.dd.paed.data
                       )
}
saveRDS(PMCdata, file="PMCdata.RDS")

fitComparison <- function(data) {
  complexModel <- c("meta.other","meta.dd.paed","metap.np.other","metap.np.dd.paed","metap.np.dd.paed","metap.np.dd.paed")
  simpleModel <- c("bm1","meta.other","meta.other","meta.dd.paed","metap.np.other","metap.np.dd.paed")

  fits <- vector(mode='list', length=6)
  for (i in 1:6) {
    complexTree <- get(paste("tree",complexModel[i],sep="_"))
    complexData <- data[[paste("oumv",complexModel[i],"data",sep='.')]]
    if (simpleModel[i]=="bm1") {
      simpleTree <- tree_meta.other
      simpleData <- data[["bm1.data"]]
    }
    else {
      simpleTree <- get(paste("tree",simpleModel[i],sep="_"))
      if (simpleModel[i]=="metap.np.dd.paed")
        simpleData <- data[[paste("oum",simpleModel[i],"data",sep='.')]]
      else simpleData <- data[[paste("oumv",simpleModel[i],"data",sep='.')]]
    }
    
    if (simpleModel[i]=="bm1") {
      OUwie(complexTree,
          complexData,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.complex.to.complex
      OUwie(simpleTree,
          simpleData,
          model="BM1",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.simple.to.simple
      OUwie(complexTree,
          simpleData,
          model="BM1",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.simple.to.complex
      OUwie(simpleTree,
          complexData,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.complex.to.simple
    } else if (simpleModel[i]=="metap.np.dd.paed") {
      OUwie(complexTree,
          complexData,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.complex.to.complex
      OUwie(simpleTree,
          simpleData,
          model="OUM",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.simple.to.simple
      OUwie(simpleTree,
          complexData,
          model="OUM",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.simple.to.complex
      OUwie(complexTree,
          simpleData,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.complex.to.simple
    } else {
      OUwie(complexTree,
          complexData,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.complex.to.complex
      OUwie(simpleTree,
          simpleData,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.simple.to.simple
      ## Set regimes of complex data equal to the simpler model
      complexData2 <- complexData
      complexData2[,2] <- simpleData[,2]
      OUwie(simpleTree,
          complexData2,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.simple.to.complex
      ## Set regimes of simple data equal to the complex model
      simpleData2 <- simpleData
      simpleData2[,2] <- complexData[,2]
      OUwie(complexTree,
          simpleData2,
          model="OUMV",
          scaleHeight=TRUE,
          shift.point=1,
          quiet=TRUE,
          algorithm="invert") -> fit.complex.to.simple
    }
    fits[[i]] <- list(fit.complex.to.complex,
                      fit.simple.to.simple,
                      fit.complex.to.simple,
                      fit.simple.to.complex)
  }
}

numCores <- detectCores()
mclapply(PMCdata,
         fitComparison,
         mc.cores=numCores) -> PMCfits
saveRDS(PMCfits, file="PMCfits.RDS")

```

We can also use these fits to look at the confidence intervals for each of the parameters of the best-fitting model using a parametric bootstrap.

```{r}
PMCfits <- readRDS("PMCfits.RDS")
  
## Bootstrap parameter estimates
data.frame(parameter=c('alpha','sigma.sq (DD)', 'sigma.sq (M)', 'sigma.sq (Mpleth)', 'sigma.sq (P)', 'theta (DD)', 'theta (M)', 'theta (Mpleth)', 'theta (P)'),
           CI=c((lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$solution['alpha',] %>% unique) %>% unlist %>% sort)[c(12,488)] %>% signif(3) %>% paste(., collapse=", "),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$solution['sigma.sq',1]) %>% unlist %>% sort)[c(12,488)] %>% sqrt %>% signif(3) %>% paste(., collapse=", "),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$solution['sigma.sq',2]) %>% unlist %>% sort)[c(12,488)] %>% sqrt %>% signif(3) %>% paste(., collapse=", "),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$solution['sigma.sq',3]) %>% unlist %>% sort)[c(12,488)] %>% sqrt %>% signif(3) %>% paste(., collapse=", "),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$solution['sigma.sq',4]) %>% unlist %>% sort)[c(12,488)] %>% sqrt %>% signif(3) %>% paste(., collapse=", "),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$theta[1,1]) %>% unlist %>% sort)[c(12,488)] %>% signif(3) %>% paste(., collapse=","),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$theta[2,1]) %>% unlist %>% sort)[c(12,488)] %>% signif(3) %>% paste(., collapse=","),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$theta[3,1]) %>% unlist %>% sort)[c(12,488)] %>% signif(3) %>% paste(., collapse=","),
                (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$theta[4,1]) %>% unlist %>% sort)[c(12,488)] %>% signif(3) %>% paste(., collapse=","))
)
```


To determine whether the data really supports the conclusions we want to draw from the AICc table, we use the phylogenetic Monte Carlo approach of Boettiger et al. 2012. 
We define the difference in the log-likelihoods between the two models as our test statistic: $\delta  = -2 (\log L_0 - \log L_1)$, where we assume that the $L_1$ is the likelihood of the more complex model.
Higher values of this likelihood ratio indicate more support for the complex model.
We will use the simulated datasets to estimate the distribution of $\delta$ when the data is generated by either of the two models under comparison.
Our first comparison is between the meta hypothesis, fitted with the OU model (the simplest adaptive hypothesis), and the non-adaptive Brownian motion hypothesis.
The p-value for this comparison is 0.016: when the data is generated by a non-adaptive model, the value of the test statistic is almost never as large as the value that we observed with the true dataset.

```{r}
## The true value of the test statistic
delta <- -2*(results[["BM1"]]$loglik - results[["meta.OUM"]]$loglik)

## The distribution of the test statistic when the data is generated by the BM1 model
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.bm1.to.bm1.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.to.bm1.data"]]$loglik) %>% unlist))

## the proportion of the simulated values larger than the test statistic provides an approximation to the p-value for the test, the probability that a difference at least as large would be seen under model 0 (BM)

meta.v.BM.p <- sum(delta < delta.dist)/length(delta.dist)
meta.v.BM.p

```
We can also look at the overlap between the distributions of the test statistic when the data is generated by the non-adaptive model versus the adaptive model to get a sense of power. You can see that the power is fairly high (0.69), meaning that 69\% of the test statistic values when the data is generated by the adaptive model are larger than the 95th percentile of the distribution when the data is generated by the non-adaptive model. Both the p-value and the power can be visualized by a plot of the two distributions (Fig. \@ref(fig:pmcResults)A).)

```{r}
## The distribution of the test statistic when the data is generated by the oumv.meta.nf.dd.paed model
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.bm1.to.oum.meta.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.data"]]$loglik) %>% unlist))
## The degree of overlap between this distribution and the one above gives a sense of the power.
## The amount of this distribution to the right of the test statistic value that would reject the non-adaptive model with a false positive rate of 5% above gives the probability of rejecting model 0 when the data are produced by model 1 (e.g., the power)
meta.v.bm.power <- sum(delta.dist.2 > sort(delta.dist)[475])/length(delta.dist.2)
meta.v.bm.power 
```

Using the same methodology, we can calculate the approximate p-value and power for the second test, between $meta-paed-dd$ (OUM) and $metamorphosis-other$ (OUM). This tests whether more finely subdividing non-metamorphosing strategies into direct development and paedomorphosis provides a better fit to the data than simply between distinguishing between metamorphosing and non-metamorphosing strategies. Here the p-value is 0.096 and the power is 0.39, suggesting that the addition of direct development and paedomorphosis as separate constraint regimes does not really improve the explanatory power of the model. See Fig. \@ref(fig:pmcResults)B for a visual depiction of these results.

```{r}
delta <- -2*(results[["meta.OUM"]]$loglik - results[["meta.dd.paed.OUM"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oum.meta.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist))
## p-value
meta.dd.paed.v.meta.p <- sum(delta < delta.dist)/length(delta.dist)
## power
meta.dd.paed.v.meta.power <- sum(delta.dist.2 > sort(delta.dist)[475])/length(delta.dist.2)
meta.dd.paed.v.meta.p
meta.dd.paed.v.meta.power
```

Using the same methodology, we can calculate the approximate p-value and power for the third test, $meta_f-meta_{nf}-other$ (OUMV) and $metamorphosis-other$ (OUM). This tests whether distinguishing between different metamorphosis strategies is supported. Here the p-value is 0.032 and the power is 0.796, implying we can confidently reject the hypothesis that the simpler model produces a better fit to the data than the more complicated model that distinguishes among metamorphosing life histories. See Fig. \@ref(fig:pmcResults)C for a visual depiction of these results.


```{r}
delta <- -2*(results[["meta.OUM"]]$loglik - results[["meta.nf.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oum.meta.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oumv.meta.nf.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oumv.meta.nf.data"]]$loglik) %>% unlist))
## p-value
meta.nf.v.meta.p <- sum(delta < delta.dist)/length(delta.dist)
## power
meta.nf.v.meta.power <- sum(delta.dist.2 > sort(delta.dist)[475])/length(delta.dist.2)
meta.nf.v.meta.p
meta.nf.v.meta.power
```


We also calculate the p-value and power for the fourth test, $meta_f-meta_{nf}-paed-dd$ (OUMV) versus $meta-paed-dd$ (OUM). This tests whether separate regimes for feeding and non-feeding metamorphosis are supported, after accounting for the two non-metamorphosing strategies. Given the results above, it is unsurprising that the more complicated model is strongly supported, with a p-value of 0.03 and power of 0.88. See Fig. \@ref(fig:pmcResults)D for a visual depiction of these results.

```{r}
delta <- -2*(results[["meta.dd.paed.OUM"]]$loglik - results[["meta.nf.dd.paed.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
## p-value
meta.nf.dd.paed.v.meta.dd.paed.p <- sum(delta < delta.dist)/length(delta.dist)
## power
meta.nf.dd.paed.v.meta.dd.paed.power <- sum(delta.dist.2 > sort(delta.dist)[475])/length(delta.dist.2)
meta.nf.dd.paed.v.meta.dd.paed.p
meta.nf.dd.paed.v.meta.dd.paed.power
```

We also calculate the p-value and power for the fifth test, $meta_f-meta_{nf}-paed-dd$ (OUMV) versus $meta_f-meta_{nf}-other$ (OUMV). This tests whether allowing separate regimes for direct developers and paedomorphs is supported, once you have accounted for feeding and non-feeding metamorphosis. For this comparison, the p-value is 0.1 and the power is 0.54, indicating that there is some support for the more complex model, although it is not strong. See Fig. \@ref(fig:pmcResults)E for a visual depiction of these results.

```{r}
delta <- -2*(results[["meta.nf.OUMV"]]$loglik - results[["meta.nf.dd.paed.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oumv.meta.nf.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
## p-value
meta.nf.dd.paed.v.meta.nf.p <- sum(delta < delta.dist)/length(delta.dist)
## power
meta.nf.dd.paed.v.meta.nf.power <- sum(delta.dist.2 > sort(delta.dist)[475])/length(delta.dist.2)
meta.nf.dd.paed.v.meta.nf.p
meta.nf.dd.paed.v.meta.nf.power
```


Finally, just to cross all the t's and dot all the i's, we can calculate the p-value and power for the sixth test, $meta_f-meta_{nf}-paed-dd$ (OUMV) versus $meta_f-meta_{nf}-paed-dd$ (OUM), which tests whether multiple $\sigma$ values is well-supported by the data. Here the p-value is 0.088 and the power is 0.67, suggesting fairly good support for the more complex model. See Fig. \@ref(fig:pmcResults)F for a visual depiction of these results.

```{r}
delta <- -2*(results[["meta.nf.dd.paed.OUM"]]$loglik - results[["meta.nf.dd.paed.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.nf.dd.paed.to.oum.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oum.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
## p-value
meta.nf.dd.paed.oumv.v.meta.nf.dd.paed.oum.p <- sum(delta < delta.dist)/length(delta.dist)
## power
meta.nf.dd.paed.oumv.v.meta.nf.dd.paed.oum.power  <-sum(delta.dist.2 > sort(delta.dist)[475])/length(delta.dist.2)
meta.nf.dd.paed.oumv.v.meta.nf.dd.paed.oum.p
meta.nf.dd.paed.oumv.v.meta.nf.dd.paed.oum.power
```

```{r pmcResults, echo=FALSE, fig.height=7.5, fig.width=10, fig.cap="Comparing the distributions of the test statistic when the data is generated by simpler (light gray) or more complex (dark gray) evolutionary models. The dashed line gives the actual value of the test statistic for the true data."}
par(mar=c(2.5,2.5,1,1), oma=c(2,2,0,0), mfrow=c(2,3))
## BM1 versus meta.nf.dd.paed OUMV
delta <- -2*(results[["BM1"]]$loglik - results[["meta.OUM"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.bm1.to.bm1.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.to.bm1.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.bm1.to.oum.meta.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.data"]]$loglik) %>% unlist))
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
mtext(side=1, outer=T, expression(delta))
mtext(side=2, outer=T, 'Density')
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('BM','meta-other',paste0('p=',meta.v.BM.p),paste0('power=',meta.v.bm.power)), fill=c(gray(0.7),gray(0.2),gray(1),gray(1)),border=c(1,1,0,0), bty='n', cex=1.1)
legend(x=min(c(d1$x,d2$x)), y=max(c(d1$y,d2$y)), "A", bty='n', xjust=0.5, yjust=0.5)

## meta versus meta.dd.paed
delta <- -2*(results[["meta.OUM"]]$loglik - results[["meta.dd.paed.OUM"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oum.meta.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist))
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('meta-other','meta-paed-dd',paste0('p=',meta.dd.paed.v.meta.p),paste0('power=',meta.dd.paed.v.meta.power)), fill=c(gray(0.7),gray(0.2),0,0), border=c(1,1,0,0), bty='n', cex=1.1)
legend(x=min(c(d1$x,d2$x)), y=max(c(d1$y,d2$y)), "B", bty='n', xjust=0.5, yjust=0.5)

## meta versus meta.nf
delta <- -2*(results[["meta.OUM"]]$loglik - results[["meta.nf.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oum.meta.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oum.meta.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.to.oumv.meta.nf.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oumv.meta.nf.data"]]$loglik) %>% unlist))
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('meta-other',expression('meta'['f']~'-meta'['nf']~'-other'),paste0('p=',meta.nf.v.meta.p),paste0('power=',meta.nf.v.meta.power)), fill=c(gray(0.7),gray(0.2),0,0), border=c(1,1,0,0), bty='n', cex=1.1)
legend(x=min(c(d1$x,d2$x)), y=max(c(d1$y,d2$y)), "C", bty='n', xjust=0.5, yjust=0.5)

## meta.dd.paed OUM versus meta.nf.dd.paed OUMV
delta <- -2*(results[["meta.dd.paed.OUM"]]$loglik - results[["meta.nf.dd.paed.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oum.meta.dd.paed.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c('meta-paed-dd',expression('meta'['f']~'-meta'['nf']~'-paed-dd'),paste0('p=',meta.nf.dd.paed.v.meta.dd.paed.p),paste0('power=',meta.nf.dd.paed.v.meta.dd.paed.power)), fill=c(gray(0.7),gray(0.2),0,0), border=c(1,1,0,0),bty='n', cex=1.1)
legend(x=min(c(d1$x,d2$x)), y=max(c(d1$y,d2$y)), "D", bty='n', xjust=0.5, yjust=0.5)


## meta.nf (OUMV) versus meta.nf.dd.paed (OUMV)
delta <- -2*(results[["meta.nf.OUMV"]]$loglik - results[["meta.nf.dd.paed.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oumv.meta.nf.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c(expression('meta'['f']~'-meta'['nf']~'-other'),expression('meta'['f']~'-meta'['nf']~'-paed-dd'),paste0('p=',meta.nf.dd.paed.v.meta.nf.p), paste0('power=',meta.nf.dd.paed.v.meta.nf.power)), fill=c(gray(0.7),gray(0.2)), bty='n', cex=1.1)
legend(x=min(c(d1$x,d2$x)), y=max(c(d1$y,d2$y)), "E", bty='n', xjust=0.5, yjust=0.5)

##  meta.nf.dd.paed OUM versus meta.nf.dd.paed OUMV
delta <- -2*(results[["meta.nf.dd.paed.OUM"]]$loglik - results[["meta.nf.dd.paed.OUMV"]]$loglik)
delta.dist <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.nf.dd.paed.to.oum.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oum.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
delta.dist.2 <- -2*((lapply(PMCfits, function(f) f[["fit.oum.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist) - 
                    (lapply(PMCfits, function(f) f[["fit.oumv.meta.nf.dd.paed.to.oumv.meta.nf.dd.paed.data"]]$loglik) %>% unlist))
d1 <- density(delta.dist)
d2 <- density(delta.dist.2)
plot.new()
plot.window(xlim=range(c(d1$x,d2$x)), ylim=range(c(d1$y,d2$y)))
axis(1);axis(2);box('plot')
lines(d1$x, d1$y, col=gray(0.7))
with(d1, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.7, alpha=0.5)))
lines(d2$x, d2$y, col=gray(0.2))
with(d2, polygon(x=c(min(x), x[x<max(x)], rev(x[x<max(x)]), min(x)), y=c(0, 0*x[x<max(x)], rev(y[x<max(x)]), 0), col=gray(0.2, alpha=0.5)))
abline(v=delta, lwd=2, lty=2)
legend(x='topright', c(expression('meta'['f']~'-meta'['nf']~'-paed-dd'~'('~theta[i]~','~sigma~','~alpha~')'),expression('meta'['f']~'-meta'['nf']~'-paed-dd'~'('~theta[i]~','~sigma[i]~','~alpha~')'),paste0('p=',meta.nf.dd.paed.oumv.v.meta.nf.dd.paed.oum.p),paste0('power=',meta.nf.dd.paed.oumv.v.meta.nf.dd.paed.oum.power)), fill=c(gray(0.7),gray(0.2),0,0), border=c(1,1,0,0), bty='n', cex=1.1)
legend(x=min(c(d1$x,d2$x)), y=max(c(d1$y,d2$y)), "F", bty='n', xjust=0.5, yjust=0.5)

```

## Analyses with a different evolutionary history for plethodontids
In the above analyses, the ancestor of all plethodontids is assumed to be a metamorphosing amphibian. However, there is some debate about this, and some researchers think that this ancestor was actually a direct developer. As such, we want to make sure that the conlusions drawn above are unaffected by this assumption. This requires modifying all three adaptive hypotheses to "repaint" the ancestral node.

```{r hyp_alt_history, echo=FALSE, fig.width=10, fig.height=10, fig.cap="The four regime paintings with the ancestral node for plethodontids set as a direct developer, rather than a metamorphoser."}
# which(tree_meta.nf.dd.paed$node.label=="3")
# [1] 23 40 41 42 45 46 81 82 83 85 86 87 88
tree_meta.nf.dd.paed2 <- tree_meta.nf.dd.paed
tree_meta.nf.dd.paed2$node.label[23] <- "1"

tree_meta.nf2 <- tree_meta.nf
tree_meta.nf2$node.label[23] <- "5"

tree_meta.dd.paed2 <- tree_meta.dd.paed
tree_meta.dd.paed2$node.label[23] <- "1"

tree_meta2 <- tree_meta
tree_meta2$node.label[23] <- "5"

par(mar=c(0.5,0.5,2,0.5), oma=c(0.5,0.5,0.5,0.5), mfrow=c(1,5))
plot(tree_meta2, show.tip.label=FALSE)
mtext("meta", side=3, line=0, cex=0.75)
nodelabels(pch=21, bg=tree_meta$node.label)

plot(tree_meta.nf2, show.tip.label=FALSE)
mtext("meta-nf", side=3, line=0, cex=0.75)
nodelabels(pch=21, bg=tree_meta.nf$node.label)

plot(tree_meta.dd.paed2, show.tip.label=FALSE)
mtext("meta-paed-dd", side=3, line=0, cex=0.75)
nodelabels(pch=21, bg=tree_meta.dd.paed$node.label)

par(mar=c(0.5,0.5,2,0))
plot(tree_meta.nf.dd.paed2, show.tip.label=FALSE)
mtext("meta-nf-paed-dd", side=3, line=0, cex=0.75)
nodelabels(pch=21, bg=tree_meta.nf.dd.paed$node.label)

par(mar=c(0.5,0,2,0))
plot.new()
plot.window(xlim=c(0,1), ylim=c(0,1))
for (i in 1:length(tree_meta$tip.label))
    text(0, 1-(i-1)/(length(tree_meta$tip.label)-1),
         paste(strsplit(tree_meta$tip.label[1],"_")[[1]][1], strsplit(tree_meta$tip.label[i],"_")[[1]][2]),
         cex=0.65, adj=0)



```


```{r, echo=FALSE, eval=FALSE}
## Fit all of the model variants (BMS, OUMA, OUMV, OUMVA) to each hypothesis
meta.OUM <- OUwie(tree_meta2,data.meta,model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.BMS <- OUwie(tree_meta2,data.meta,model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.OUMA <- OUwie(tree_meta2,data.meta,model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.OUMV <- OUwie(tree_meta2,data.meta,model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.OUMVA <- OUwie(tree_meta2,data.meta,model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

meta.nf.OUM <- OUwie(tree_meta.nf2,data.meta.nf,model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.BMS <- OUwie(tree_meta.nf2,data.meta.nf,model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.OUMA <- OUwie(tree_meta.nf2,data.meta.nf,model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.OUMV <- OUwie(tree_meta.nf2,data.meta.nf,model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.OUMVA <- OUwie(tree_meta.nf2,data.meta.nf,model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

meta.dd.paed.OUM <- OUwie(tree_meta.dd.paed2,data.meta.dd.paed,model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.BMS <- OUwie(tree_meta.dd.paed2,data.meta.dd.paed,model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.OUMA <- OUwie(tree_meta.dd.paed2,data.meta.dd.paed,model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.OUMV <- OUwie(tree_meta.dd.paed2,data.meta.dd.paed,model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.dd.paed.OUMVA <- OUwie(tree_meta.dd.paed2,data.meta.dd.paed,model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

meta.nf.dd.paed.OUM <- OUwie(tree_meta.nf.dd.paed2,data.meta.nf.dd.paed,model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.dd.paed.BMS <- OUwie(tree_meta.nf.dd.paed2,data.meta.nf.dd.paed,model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.dd.paed.OUMA <- OUwie(tree_meta.nf.dd.paed2,data.meta.nf.dd.paed,model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.dd.paed.OUMV <- OUwie(tree_meta.nf.dd.paed2,data.meta.nf.dd.paed,model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
meta.nf.dd.paed.OUMVA <- OUwie(tree_meta.nf.dd.paed2,data.meta.nf.dd.paed,model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

## save these results
results <- list(meta.OUM=meta.OUM,
                meta.BMS=meta.BMS,
                meta.OUMA=meta.OUMA,
                meta.OUMV=meta.OUMV,
                meta.OUMVA=meta.OUMVA,
                meta.nf.OUM=meta.nf.OUM,
                meta.nf.BMS=meta.nf.BMS,
                meta.nf.OUMA=meta.nf.OUMA,
                meta.nf.OUMV=meta.nf.OUMV,
                meta.nf.OUMVA=meta.nf.OUMVA,
                meta.dd.paed.OUM=meta.dd.paed.OUM,
                meta.dd.paed.BMS=meta.dd.paed.BMS,
                meta.dd.paed.OUMA=meta.dd.paed.OUMA,
                meta.dd.paed.OUMV=meta.dd.paed.OUMV,
                meta.dd.paed.OUMVA=meta.dd.paed.OUMVA,
                meta.nf.dd.paed.OUM=meta.nf.dd.paed.OUM,
                meta.nf.dd.paed.BMS=meta.nf.dd.paed.BMS,
                meta.nf.dd.paed.OUMA=meta.nf.dd.paed.OUMA,
                meta.nf.dd.paed.OUMV=meta.nf.dd.paed.OUMV,
                meta.nf.dd.paed.OUMVA=meta.nf.dd.paed.OUMVA
                )
saveRDS(results, "all_model_fits_alt_history.RDS")

```

```{r, echo=FALSE}
results <- readRDS("all_model_fits_alt_history.RDS")
```

You can see that changing this ancestral node has absolutely no effect on the model fitting results, which is unsurpising given how deep in the tree this switch occurs, and how short the branch is that is affected by the change.

```{r, echo=FALSE}
data.frame(Hypothesis = lapply(results, function(x) x$AICc) %>% unlist %>% names, 
           AICc = lapply(results, function(x) x$AICc) %>% unlist %>% signif(3),
           alpha = lapply(results, function(x) unique(x$solution['alpha',]) %>% signif(3)) %>% unlist,
           sigma.sq = lapply(results, function(x) unique(x$solution['sigma.sq',]) %>% signif(3) %>% paste(., collapse=", ")) %>% unlist,
           theta = lapply(results, function(x) x$theta[,1] %>% signif(3) %>% paste(., collapse=", ")) %>% unlist
           ) %>% 
  arrange(AICc) %>% as.data.frame
```

