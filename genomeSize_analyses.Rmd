---
title: "Phylogenetic Analysis of Salamander Genome Size"
author: "Clay Cressler"
date: "02/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

This is an updated version of the analyses that were initially carried out several years ago. 
We had wanted to use $\texttt{Ouwie}$ to do these analyses but previously, there were undiagnosed issues with its fitting algorithm.
As such, we ended up using $\texttt{ouch}$ for all analyses, which prevented us from ever testing models with multiple $\alpha$ or $\sigma^2$ parameters.
However, I spent time working through these issues in Spring 2020 and am now satisfied that $\texttt{ouch}$ and $\texttt{OUwie}$ produce identical results, at least once you specify a value for 'shift.point' to make the way that $\texttt{OUwie}$ handles regimes identical to $\texttt{ouch}$.
Nevertheless, I will fit the models using both $\texttt{OUwie}$ and $\texttt{ouch}$ to confirm they are giving similar results when they should. 

```{r, echo=FALSE}
library(ape, quietly=TRUE)
library(ouch, quietly=TRUE)
library(OUwie, quietly=TRUE)
library(tidyverse)

tree <- read.nexus("av_ultra_fulldataset.nex")
tree_metamorphosis <- tree_mpd <- tree_mpdMpleth <- tree
## Load the hypotheses
nodedata <- read.csv('ouwie_nodelabels.csv')
nodedata <- nodedata[,c('node','metamorphosis','mpd','mpdMpleth')]
## metamorphosis has two regimes: M, x
## mpd has three regimes: D, M, P
## mpdMpleth has four regimes: D, M, Mpleth, P
## Node Colors for plots
nodecol <- nodedata
nodecol[-1] <- sapply(nodecol[-1], as.character)
nodecol[nodecol=="x"] <- "brown"
nodecol[nodecol=="M"] <- "red"
nodecol[nodecol=="D"] <- "black"
nodecol[nodecol=="P"] <- "dodgerblue1"
nodecol[nodecol=="Mpleth"] <- "purple"
## code Regime names as numbers for the OUwie algorithm
nn <- nodedata
nn[-1] <- sapply(nn[-1], as.character)
nn[nn=="D"] <- 1
nn[nn=="M"] <- 2
nn[nn=="Mpleth"] <- 3
nn[nn=="P"] <- 4
nn[nn=="x"] <- 5
## Add node labels to trees
tree_metamorphosis$node.label <- nn$metamorphosis
tree_mpd$node.label <- nn$mpd
tree_mpdMpleth$node.label <- nn$mpdMpleth
## Tip data
dat <- read.csv("tree1.dat.csv")
dat$genomesize <- log(dat$genomesize)
tdat <- dat[!is.na(dat$genomesize),]  # tip data
ndat <- dat[is.na(dat$genomesize),]   # node data
## reorder tdat to match order of tip labels in phylo tree
oo <- sapply(tree$tip.label, function(x) grep(x, tdat$labels))
tipdat <- tdat[oo,]
tipdat <- tipdat[c("labels", "metamorphosis", "mpd", "mpdMpleth", "genomesize")]
## Tip Colors for plots
tipcol <- tipdat
tipcol[,1:(ncol(tipdat)-1)] <- sapply(tipcol[,1:(ncol(tipdat)-1)], as.character)
tipcol[tipcol=="x"] <- "brown"
tipcol[tipcol=="M"] <- "red"
tipcol[tipcol=="D"] <- "black"
tipcol[tipcol=="P"] <- "dodgerblue1"
tipcol[tipcol=="Mpleth"] <- "purple"
## code Regime names as numbers for the OUwie algorithm
tt <- tipdat
tt[,1:(ncol(tipdat)-1)] <- sapply(tt[,1:(ncol(tipdat)-1)], as.character)
tt[tt=="D"] <- 1
tt[tt=="M"] <- 2
tt[tt=="Mpleth"] <- 3
tt[tt=="P"] <- 4
tt[tt=="x"] <- 5

### input dataframes - one for each hypothesis
data.metamorphosis <- tt[c("labels", "metamorphosis", "genomesize")]
data.mpd <- tt[c("labels", "mpd", "genomesize")]
data.mpdMpleth <- tt[c("labels", "mpdMpleth", "genomesize")]


##############################################################
## OUCH setup
##############################################################
dat1 <- read.csv("tree1.dat.csv")
tree1 <- read.nexus("av_ultra_fulldataset.nex")
tree <- ape2ouch(tree1)
dat <- dat1
rownames(dat) <- dat$nodes
regimes <- dat[c("metamorphosis", "mpd", "mpdMpleth","OU1","fivereg")]
gsz <- log(dat['genomesize'])
```

First up is a simple comparison of Brownian motion fits, which you can see are almost identical. 

```{r, echo=TRUE}
## Single-rate BM (this is hypothesis-independent)
bm.ouwie <- OUwie(tree_mpdMpleth,data.mpdMpleth,model=c("BM1"),root.station=TRUE,scaleHeight=TRUE,quiet=TRUE)
bm.ouch <- brown(gsz, tree)

summary(bm.ouch)$sigma.squared %>% as.numeric
bm.ouwie$solution["sigma.sq",]

summary(bm.ouch)$theta %>% as.numeric
bm.ouwie$theta[1]

```
```{r fig:mpdMpleth, fig.height=6, fig.width=6, fig.cap="The mpdMpleth regime painting"}
plot(tree_mpdMpleth)
nodelabels(pch=21, bg=tree_mpdMpleth$node.label)

```
Now let's fit a multiple-optima Ornstein-Uhlenbeck model to the mpdMpleth regime painting using both $\texttt{OUwie}$ and $\texttt{ouch}$, shown in Fig. \@ref(fig:mpdMpleth).
From this, you can see that all of the parameter estimates are quite similar, and the likelihood, calculated by $\texttt{ouch}$ using the $\texttt{OUwie}$ parameter estimates, is identical to the fourth decimal place. 
Obviously I wish they were completely identical, but I'll take it.

```{r, echo=TRUE}
## Fit the mpdMpleth hypothesis
mpdMpleth.ouwie <- OUwie(tree_mpdMpleth,data.mpdMpleth,model=c("OUM"),root.station=TRUE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpdMpleth.ouch <- hansen(gsz, tree, regimes['mpdMpleth'], sqrt.alpha=1, sigma=1)

## Compare sigma.sq estimates
summary(mpdMpleth.ouch)$sigma.squared %>% as.numeric
mpdMpleth.ouwie$solution["sigma.sq",1]

## Compare alpha estimates
summary(mpdMpleth.ouch)$alpha %>% as.numeric
mpdMpleth.ouwie$solution["alpha",1]

## Compare optima estimates
summary(mpdMpleth.ouch)$optima$genomesize
mpdMpleth.ouwie$theta[,1]

## Compare the likelihoods
summary(hansen(gsz, tree=tree, regimes=regimes['mpdMpleth'], sqrt.alpha=sqrt(mpdMpleth.ouwie$solution["alpha",1]), sigma=sqrt(mpdMpleth.ouwie$solution["sigma.sq",1]), fit=FALSE))$loglik
mpdMpleth.ouwie$loglik


```

I will repeat this analysis with both methods for the other regime paintings, starting with the mpd painting shown in Fig. \@ref(fig:mpd).
And again, we see really strong evidence that the two methods are nearly identical.

```{r fig:mpd, fig.height=6, fig.width=6, fig.cap="The mpd regime painting"}
plot(tree_mpd)
nodelabels(pch=21, bg=tree_mpd$node.label)

```


```{r, echo=TRUE}
## Fit the mpd hypothesis
mpd.ouwie <- OUwie(tree_mpd,data.mpd,model=c("OUM"),root.station=TRUE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpd.ouch <- hansen(gsz, tree, regimes['mpd'], sqrt.alpha=1, sigma=1)

## Compare sigma.sq estimates
summary(mpd.ouch)$sigma.squared %>% as.numeric
mpd.ouwie$solution["sigma.sq",1]

## Compare alpha estimates
summary(mpd.ouch)$alpha %>% as.numeric
mpd.ouwie$solution["alpha",1]

## Compare optima estimates
summary(mpd.ouch)$optima$genomesize
mpd.ouwie$theta[,1]

## Compare the likelihoods
summary(hansen(gsz, tree=tree, regimes=regimes['mpd'], sqrt.alpha=sqrt(mpd.ouwie$solution["alpha",1]), sigma=sqrt(mpd.ouwie$solution["sigma.sq",1]), fit=FALSE))$loglik
mpd.ouwie$loglik
```

Finally, I will consider the 'metamorphosis' tree painting shown in Fig. \@ref(fig:meta), where I again see good agreement between $\texttt{OUwie}$ and $\texttt{ouch}$.

```{r fig:meta, fig.height=6, fig.width=6, fig.cap="The metamorphosis regime painting"}
plot(tree_metamorphosis)
nodelabels(pch=21, bg=tree_metamorphosis$node.label)

```

```{r, echo=TRUE}
## Fit the metamorphosis hypothesis
metamorphosis.ouwie <- OUwie(tree_metamorphosis,data.metamorphosis,model=c("OUM"),root.station=TRUE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metamorphosis.ouch <- hansen(gsz, tree, regimes['metamorphosis'], sqrt.alpha=1, sigma=1)

## Compare sigma.sq estimates
summary(metamorphosis.ouch)$sigma.squared %>% as.numeric
metamorphosis.ouwie$solution["sigma.sq",1]

## Compare alpha estimates
summary(metamorphosis.ouch)$alpha %>% as.numeric
metamorphosis.ouwie$solution["alpha",1]

## Compare optima estimates
summary(metamorphosis.ouch)$optima$genomesize
metamorphosis.ouwie$theta[,1]

## Compare the likelihoods
summary(hansen(gsz, tree=tree, regimes=regimes['metamorphosis'], sqrt.alpha=sqrt(metamorphosis.ouwie$solution["alpha",1]), sigma=sqrt(metamorphosis.ouwie$solution["sigma.sq",1]), fit=FALSE))$loglik
metamorphosis.ouwie$loglik
```
As such, I will proceed with fitting all of the other multi-rate models: a Brownian motion model where the drift parameter ($\sigma$) varies across regimes (BMS), an Ornstein-Uhlenbeck (OU) model where selection strength varies across regimes ($\alpha$) (OUMA), an OU model where drift varies across regimes (OUMV), and an OU model where both selection and drift vary across regimes (OUMVA). 

```{r, echo=TRUE, eval=FALSE}
## Fit all of the model variants (BMS, OUMA, OUMV, OUMVA) to each hypothesis
metamorphosis.OUM <- OUwie(tree_metamorphosis,data.metamorphosis,model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metamorphosis.BMS <- OUwie(tree_metamorphosis,data.metamorphosis,model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metamorphosis.OUMA <- OUwie(tree_metamorphosis,data.metamorphosis,model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metamorphosis.OUMV <- OUwie(tree_metamorphosis,data.metamorphosis,model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
metamorphosis.OUMVA <- OUwie(tree_metamorphosis,data.metamorphosis,model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

mpd.OUM <- OUwie(tree_mpd,data.mpd,model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpd.BMS <- OUwie(tree_mpd,data.mpd,model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpd.OUMA <- OUwie(tree_mpd,data.mpd,model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpd.OUMV <- OUwie(tree_mpd,data.mpd,model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpd.OUMVA <- OUwie(tree_mpd,data.mpd,model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

mpdMpleth.OUM <- OUwie(tree_mpdMpleth,data.mpdMpleth,model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpdMpleth.BMS <- OUwie(tree_mpdMpleth,data.mpdMpleth,model=c("BMS"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpdMpleth.OUMA <- OUwie(tree_mpdMpleth,data.mpdMpleth,model=c("OUMA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpdMpleth.OUMV <- OUwie(tree_mpdMpleth,data.mpdMpleth,model=c("OUMV"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)
mpdMpleth.OUMVA <- OUwie(tree_mpdMpleth,data.mpdMpleth,model=c("OUMVA"), scaleHeight=TRUE, shift.point=1, quiet=TRUE)

## save these results
results <- list(BM1=bm.ouwie,
                metamorphosis.OUM=metamorphosis.OUM,
                metamorphosis.BMS=metamorphosis.BMS,
                metamorphosis.OUMA=metamorphosis.OUMA,
                metamorphosis.OUMV=metamorphosis.OUMV,
                metamorphosis.OUMVA=metamorphosis.OUMVA,
                mpd.OUM=mpd.OUM,
                mpd.BMS=mpd.BMS,
                mpd.OUMA=mpd.OUMA,
                mpd.OUMV=mpd.OUMV,
                mpd.OUMVA=mpd.OUMVA,
                mpdMpleth.OUM=mpdMpleth.OUM,
                mpdMpleth.BMS=mpdMpleth.BMS,
                mpdMpleth.OUMA=mpdMpleth.OUMA,
                mpdMpleth.OUMV=mpdMpleth.OUMV,
                mpdMpleth.OUMVA=mpdMpleth.OUMVA
                )
saveRDS(results, "all_model_fits.RDS")

```

```{r}
results <- readRDS("all_model_fits.RDS")
```

The best-fitting model is the OU model with 4 selective regimes (1=direct development, 2=metamorphosis, 3=metamorphosing plethodontids, 4=paedomorphosis), with separate drift parameters for each regime, although the model with a single drift parameter has very similar AICc score.

```{r, echo=TRUE}
data.frame(Hypothesis = lapply(results, function(x) x$AICc) %>% unlist %>% names, 
           AICc = lapply(results, function(x) x$AICc) %>% unlist) %>% 
  arrange(AICc)
```

To help interpret the biological implications of the parameter values of the best-fitting model, it is useful to calculate the values of the selection strength and drift terms of the OU model ($\alpha*(\theta-X)$ and $\sigma$).
I will assume that $X$ is the average genome size for salamanders in each of the selective regimes. 
Plugging those genome size values, along with the corresponding parameter estimates for each regime gives a sense of how strong selection and drift are in each regime.
Based on this data, you can say genome size for the direct developers and the metamorphosers is primarily driven by drift, whereas metamorphosing plethodontids appear to be under fairly strong selection for small genome size and paedomorphs for large genome size.

```{r, echo=TRUE}
data.mpdMpleth %>% group_by(mpdMpleth) %>% summarise(meanGenomeSize=signif(mean(genomesize),3)) %>% 
  mutate(., 
         alpha=results[["mpdMpleth.OUMV"]]$solution['alpha',] %>% signif(3),
         theta=results[["mpdMpleth.OUMV"]]$theta[,1] %>% signif(3),
         'selection strength'=(alpha*(theta-meanGenomeSize)) %>% signif(3),
         'drift intensity'=sqrt(results[["mpdMpleth.OUMV"]]$solution['sigma.sq',]) %>% signif(3))
                    
```

However, it is important to assess how strong the support for this hypothesis truly is. 
Following the protocol of Boettiger et al. (2012) for phylogenetic Monte Carlo, I need to simulate datasets under different models and ask how often the true (data-generating) model is rejected in favor of an alternative model.
We will do the following pairwise comparisons of models: 
1. mpdMpleth (OUMV) versus BM1: this tests whether we can confidently reject a non-adaptive hypothesis;
2. mpdMpleth (OUMV) versus mpdMpleth (OUM): this tests whether multiple $\sigma$ values is actually well-supported;
3. mpdMpleth (OUMV) versus mpd (OUM): this tests whether a separate regime for metamorphosing plethodontids is supported;
4. mpdMpleth (OUMV) versus metamorphosis (OUM): this tests whether distinguishing between differnet non-metamorphosis strategies is supported.
So we will simulate datasets under each of the 5 models above, and then fit data generated by each of the two models under comparison to each of those models.


```{r, eval=FALSE}

## Generate 1000 simulated datasets under each of the 5 models of interest
PMCdata <- list(length=1000)
for (i in 1:1000) {
  print(i)
  ## simulate a dataset with each of the 5 models under consideration
  ## Brownian motion
  OUwie.sim(tree_mpdMpleth, 
            data.mpdMpleth, 
            shift.point=1, 
            alpha=rep(1e-10,4),
            sigma.sq=rep(results[["BM1"]]$solution['sigma.sq',] %>% as.numeric,4),
            theta0=results[["BM1"]]$theta[1,1] %>% as.numeric,
            theta=rep(results[["BM1"]]$theta[1,1] %>% as.numeric,4),
            ) -> bm1.data
  ## OUM under the mpdMpleth hypothesis
  OUwie.sim(tree_mpdMpleth, 
            data.mpdMpleth, 
            shift.point=1, 
            alpha=results[["mpdMpleth.OUM"]]$solution['alpha',] %>% as.numeric,
            sigma.sq=results[["mpdMpleth.OUM"]]$solution['sigma.sq',] %>% as.numeric,
            theta0=results[["mpdMpleth.OUM"]]$theta[2,1] %>% as.numeric,
            theta=results[["mpdMpleth.OUM"]]$theta[,1] %>% as.numeric) -> oum.mpdMpleth.data
  ## Note: OUwie.sim rewrites the names of the regimes, so fix that problem now or when you do any 
  ## refitting there will be problems (in particular, tree_mpdMpleth and oum.mpdMpleth.data have different
  ## names for the regimes represented on the internal nodes and the tips, respectively)
  oum.mpdMpleth.data[,2] <- data.mpdMpleth[,2]
  ## OUMV under the mpdMpleth hypothesis
  OUwie.sim(tree_mpdMpleth, 
            data.mpdMpleth, 
            shift.point=1, 
            alpha=results[["mpdMpleth.OUMV"]]$solution['alpha',] %>% as.numeric,
            sigma.sq=results[["mpdMpleth.OUMV"]]$solution['sigma.sq',] %>% as.numeric,
            theta0=results[["mpdMpleth.OUMV"]]$theta[2,1] %>% as.numeric,
            theta=results[["mpdMpleth.OUMV"]]$theta[,1] %>% as.numeric) -> oumv.mpdMpleth.data
  oumv.mpdMpleth.data[,2] <- data.mpdMpleth[,2]
  ## OUM under the mpd hypothesis
  OUwie.sim(tree_mpd, 
            data.mpd, 
            shift.point=1, 
            alpha=results[["mpd.OUM"]]$solution['alpha',] %>% as.numeric,
            sigma.sq=results[["mpd.OUM"]]$solution['sigma.sq',] %>% as.numeric,
            theta0=results[["mpd.OUM"]]$theta[2,1] %>% as.numeric,
            theta=results[["mpd.OUM"]]$theta[,1] %>% as.numeric) -> oum.mpd.data
  oum.mpd.data[,2] <- data.mpd[,2]
  ## OUM under the meta hypothesis
  OUwie.sim(tree_metamorphosis, 
            data.metamorphosis, 
            shift.point=1, 
            alpha=results[["metamorphosis.OUM"]]$solution['alpha',] %>% as.numeric,
            sigma.sq=results[["metamorphosis.OUM"]]$solution['sigma.sq',] %>% as.numeric,
            theta0=results[["metamorphosis.OUM"]]$theta[1,1] %>% as.numeric,
            theta=results[["metamorphosis.OUM"]]$theta[,1] %>% as.numeric) -> oum.meta.data
  oum.meta.data[,2] <- data.metamorphosis[,2]
  PMCdata[[i]] <- list(bm1.data=bm1.data,
                       oum.mpdMpleth.data=oum.mpdMpleth.data,
                       oumv.mpdMpleth.data=oumv.mpdMpleth.data,
                       oum.mpd.data=oum.mpd.data,
                       oum.meta.data=oum.meta.data)
}
saveRDS(PMCdata, file="PMCdata.RDS")

## Now, with all of this data fit the competing models according to the following pairwise comparisons of interest:
## 1. mpdMpleth (OUMV) versus BM1: this tests whether we can confidently reject a non-adaptive hypothesis;
## 2. mpdMpleth (OUMV) versus mpdMpleth (OUM): this tests whether multiple $\sigma$ values is actually well-supported;
## 3. mpdMpleth (OUMV) versus mpd (OUM): this tests whether a separate regime for metamorphosing plethodontids is supported;
## 4. mpdMpleth (OUMV) versus metamorphosis (OUM): this tests whether distinguishing between differnet non-metamorphosis strategies is supported.

fitComparison <- function(data) {
  
  #########################################################
  ## Pairwise comparision 1. mpdMpleth (OUMV) versus BM1 ##
  #########################################################
  
  ## Fit the oumv.mpdMpleth data to the mpdMpleth hypothesis under an OUMV model (the true data-generating model)
  fit.oumv.mpdMpleth.to.oumv.mpdMpleth.data <- OUwie(tree_mpdMpleth,data[["oumv.mpdMpleth.data"]],model=c("OUMV"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the oumv.mpdMpleth data to the BM1 hypothesis
  fit.bm1.to.oumv.mpdMpleth.data <- OUwie(tree_mpdMpleth,data[["oumv.mpdMpleth.data"]],model=c("BM1"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the bm1 data to the mpdMpleth hypothesis under an OUMV model
  bm1.as.mpdMpleth <- data[["bm1.data"]]
  bm1.as.mpdMpleth[,2] <- data[["oumv.mpdMpleth.data"]][,2]
  fit.oumv.mpdMpleth.to.bm1.data<- OUwie(tree_mpdMpleth,bm1.as.mpdMpleth,model=c("OUMV"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the bm1 data to the bm1 hypothesis (the true data-generating model)
  fit.bm1.to.bm1.data <- OUwie(tree_mpdMpleth, data[["bm1.data"]], model=c("BM1"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  #####################################################################
  ## Pairwise comparision 2. mpdMpleth (OUMV) versus mpdMpleth (OUM) ##
  #####################################################################
  
  ## Fit the mpdMpleth hypothesis (OUM) model to the oumv.mpdMpleth data
  fit.oum.mpdMpleth.to.oumv.mpdMpleth.data <- OUwie(tree_mpdMpleth,data[["oumv.mpdMpleth.data"]],model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the mpdMpleth hypothesis (OUMV) model to the oum.mpdMpleth data
  fit.oumv.mpdMpleth.to.oum.mpdMpleth.data <- OUwie(tree_mpdMpleth,data[["oum.mpdMpleth.data"]],model=c("OUMV"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the mpdMpleth hypothesis (OUM) model to the oum.mpdMpleth data (the true data-generating model)
  fit.oum.mpdMpleth.to.oum.mpdMpleth.data <- OUwie(tree_mpdMpleth,data[["oum.mpdMpleth.data"]],model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ###############################################################
  ## Pairwise comparision 3. mpdMpleth (OUMV) versus mpd (OUM) ##
  ###############################################################
 
  ## Fit the mpd (OUM) model to the oumv.mpdMpleth data
  mpdMpleth.as.mpd <- data[["oumv.mpdMpleth.data"]]
  mpdMpleth.as.mpd[,2] <- data[["oum.mpd.data"]][,2]
  fit.oum.mpd.to.oumv.mpdMpleth.data <- OUwie(tree_mpd, mpdMpleth.as.mpd, model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the mpdMpleth (OUMV) model to the oum.mpd data
  mpd.as.mpdMpleth <- data[["oum.mpd.data"]]
  mpd.as.mpdMpleth[,2] <- data[["oumv.mpdMpleth.data"]][,2]
  fit.oumv.mpdMpleth.to.oum.mpd.data <- OUwie(tree_mpdMpleth, mpd.as.mpdMpleth, model=c("OUMV"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the mpd (OUM) model to the oum.mpd data (the true data-generating model)
  fit.oum.mpd.to.oum.mpd.data <- OUwie(tree_mpd, data[["oum.mpd.data"]], model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  #########################################################################
  ## Pairwise comparision 4. mpdMpleth (OUMV) versus metamorphosis (OUM) ##
  #########################################################################
 
  ## Fit the metamorphosis (OUM) model to the oumv.mpdMpleth data
  mpdMpleth.as.meta <- data[["oumv.mpdMpleth.data"]]
  mpdMpleth.as.meta[,2] <- data[["oum.meta.data"]][,2]
  fit.oum.meta.to.oumv.mpdMpleth.data <- OUwie(tree_metamorphosis, mpdMpleth.as.meta, model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the mpdMpleth (OUMV) model to the oum.meta data
  meta.as.mpdMpleth <- data[["oum.meta.data"]]
  meta.as.mpdMpleth[,2] <- data[["oumv.mpdMpleth.data"]][,2]
  fit.oumv.mpdMpleth.to.oum.meta.data <- OUwie(tree_mpdMpleth, meta.as.mpdMpleth, model=c("OUMV"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  ## Fit the metamorphosis (OUM) model to the oum.meta data (the true data-generating model)
  fit.oum.meta.to.oum.meta.data <- OUwie(tree_metamorphosis, data[["oum.meta.data"]], model=c("OUM"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  #########################################################################

  list(fit.oumv.mpdMpleth.to.oumv.mpdMpleth.data=fit.oumv.mpdMpleth.to.oumv.mpdMpleth.data,
       fit.bm1.to.oumv.mpdMpleth.data=fit.bm1.to.oumv.mpdMpleth.data,
       fit.oumv.mpdMpleth.to.bm1.data=fit.oumv.mpdMpleth.to.bm1.data,
       fit.bm1.to.bm1.data=fit.bm1.to.bm1.data,
       fit.oum.mpdMpleth.to.oumv.mpdMpleth.data=fit.oum.mpdMpleth.to.oumv.mpdMpleth.data,
       fit.oumv.mpdMpleth.to.oum.mpdMpleth.data=fit.oumv.mpdMpleth.to.oum.mpdMpleth.data,
       fit.oum.mpdMpleth.to.oum.mpdMpleth.data=fit.oum.mpdMpleth.to.oum.mpdMpleth.data,
       fit.oum.mpd.to.oumv.mpdMpleth.data=fit.oum.mpd.to.oumv.mpdMpleth.data,
       fit.oumv.mpdMpleth.to.oum.mpd.data=fit.oumv.mpdMpleth.to.oum.mpd.data,
       fit.oum.mpd.to.oum.mpd.data=fit.oum.mpd.to.oum.mpd.data,
       fit.oum.meta.to.oumv.mpdMpleth.data=fit.oum.meta.to.oumv.mpdMpleth.data,
       fit.oumv.mpdMpleth.to.oum.meta.data=fit.oumv.mpdMpleth.to.oum.meta.data,
       fit.oum.meta.to.oum.meta.data=fit.oum.meta.to.oum.meta.data)
}
  
system.time(fitComparison(PMCdata[[1]]) -> timing)

library(parallel)
mclapply(PMCfits,
         fitComparison,
         mc.cores=4) -> pmcfits200

  mpdMpleth2meta <- OUwie(tree_mpdMpleth,data[["meta"]],model=c("OUMV"),root.station=FALSE, scaleHeight=TRUE, shift.point=1, quiet=TRUE)
  
  
  
}

#   fit.oum.meta.to.oum.meta.data$data %>% tail
#   fit.oumv.mpdMpleth.to.oum.meta.data$data %>% tail
#   
#   fit.oum.mpd.to.oum.mpd.data$data %>% tail
#   fit.oumv.mpdMpleth.to.oum.mpd.data$data %>% tail
#   
#   fit.bm1.to.bm1.data$data %>% tail
#   fit.oumv.mpdMpleth.to.bm1.data$data %>% tail
#   
#   fit.oumv.mpdMpleth.to.oum.mpdMpleth.data$data %>% tail
#   fit.oum.mpdMpleth.to.oum.mpdMpleth.data$data %>% tail
#   
#   fit.oum.meta.to.oumv.mpdMpleth.data$data %>% tail
#   fit.oum.mpd.to.oumv.mpdMpleth.data$data %>% tail
#   fit.oum.mpdMpleth.to.oumv.mpdMpleth.data$data %>% tail
#   fit.oumv.mpdMpleth.to.oumv.mpdMpleth.data$data %>% tail
#   fit.bm1.to.oumv.mpdMpleth.data$data %>% tail



```

```{r}

BM1fits2BM1 <- readRDS("BM1fits2BM1.RDS")
BM1fits2OUM <- readRDS("BM1fits2OUM.RDS")
BM1fits2OUMV <- readRDS("BM1fits2OUMV.RDS")
  
OUMfits2BM1 <- readRDS("OUMfits2BM1.RDS")
OUMfits2OUM <- readRDS("OUMfits2OUM.RDS")
OUMfits2OUMV <- readRDS("OUMfits2OUMV.RDS")
  
OUMVfits2BM1 <- readRDS("OUMVfits2BM1.RDS")
OUMVfits2OUM <- readRDS("OUMVfits2OUM.RDS")
OUMVfits2OUMV <- readRDS("OUMVfits2OUMV.RDS")

## Bootstrap CI for the parameters can be pulled out of the OUMVfits2OUMV file

```